"""
股票数据采集模块
支持从多种数据源采集实时行情数据
"""

from abc import ABC, abstractmethod
from typing import Dict, Any, Optional, List
import requests
import json
from datetime import datetime


class DataCollector(ABC):
    """数据采集器抽象基类"""

    @abstractmethod
    def get_stock_realtime_data(self, stock_code: str) -> Dict[str, Any]:
        """
        获取股票实时数据

        Args:
            stock_code: 股票代码

        Returns:
            股票实时数据字典
        """
        pass

    @abstractmethod
    def get_sector_data(self, sector_name: str) -> Dict[str, Any]:
        """
        获取板块数据

        Args:
            sector_name: 板块名称

        Returns:
            板块数据字典
        """
        pass

    @abstractmethod
    def get_market_index_data(self, index_name: str = "上证指数") -> Dict[str, Any]:
        """
        获取大盘指数数据

        Args:
            index_name: 指数名称

        Returns:
            指数数据字典
        """
        pass


class MockDataCollector(DataCollector):
    """模拟数据采集器（用于演示和测试）"""

    def __init__(self):
        """初始化模拟数据"""
        self.mock_stocks = {
            # 银行股
            "600000": {
                "股票代码": "600000",
                "股票名称": "浦发银行",
                "开盘价": 10.50,
                "实时价": 10.20,
                "最高价": 10.50,
                "涨停价": 11.55,
                "5日均线": 10.30,
                "20日均线": 10.15,
                "前期平台支撑位": 10.00,
                "成交额": 12500,
                "板块名称": "银行",
                "最新消息": "无"
            },
            "000001": {
                "股票代码": "000001",
                "股票名称": "平安银行",
                "开盘价": 12.80,
                "实时价": 13.15,
                "最高价": 13.20,
                "涨停价": 14.08,
                "5日均线": 12.90,
                "20日均线": 12.50,
                "前期平台支撑位": 12.30,
                "成交额": 28500,
                "板块名称": "银行",
                "最新消息": "无"
            },
            "600036": {
                "股票代码": "600036",
                "股票名称": "招商银行",
                "开盘价": 32.50,
                "实时价": 35.20,
                "最高价": 35.80,
                "涨停价": 38.25,
                "5日均线": 34.10,
                "20日均线": 33.50,
                "前期平台支撑位": 33.00,
                "成交额": 45600,
                "板块名称": "银行",
                "最新消息": "无"
            },
            "601398": {
                "股票代码": "601398",
                "股票名称": "工商银行",
                "开盘价": 5.20,
                "实时价": 5.15,
                "最高价": 5.25,
                "涨停价": 5.72,
                "5日均线": 5.18,
                "20日均线": 5.12,
                "前期平台支撑位": 5.10,
                "成交额": 89000,
                "板块名称": "银行",
                "最新消息": "无"
            },
            "601939": {
                "股票代码": "601939",
                "股票名称": "建设银行",
                "开盘价": 6.80,
                "实时价": 6.75,
                "最高价": 6.85,
                "涨停价": 7.48,
                "5日均线": 6.78,
                "20日均线": 6.70,
                "前期平台支撑位": 6.65,
                "成交额": 65000,
                "板块名称": "银行",
                "最新消息": "无"
            },
            # 科技股
            "601138": {
                "股票代码": "601138",
                "股票名称": "工业富联",
                "开盘价": 58.50,
                "实时价": 57.70,
                "最高价": 59.20,
                "涨停价": 64.35,
                "5日均线": 58.20,
                "20日均线": 57.50,
                "前期平台支撑位": 57.00,
                "成交额": 850000,
                "板块名称": "电子",
                "最新消息": "无"
            },
            "688981": {
                "股票代码": "688981",
                "股票名称": "中芯国际",
                "开盘价": 52.30,
                "实时价": 50.80,
                "最高价": 52.50,
                "涨停价": 57.53,
                "5日均线": 51.50,
                "20日均线": 50.80,
                "前期平台支撑位": 50.50,
                "成交额": 320000,
                "板块名称": "半导体",
                "最新消息": "无"
            },
            "002475": {
                "股票代码": "002475",
                "股票名称": "立讯精密",
                "开盘价": 32.80,
                "实时价": 31.50,
                "最高价": 33.00,
                "涨停价": 36.08,
                "5日均线": 32.20,
                "20日均线": 31.80,
                "前期平台支撑位": 31.50,
                "成交额": 280000,
                "板块名称": "电子",
                "最新消息": "无"
            },
            # 白酒股
            "600519": {
                "股票代码": "600519",
                "股票名称": "贵州茅台",
                "开盘价": 1680.00,
                "实时价": 1650.00,
                "最高价": 1685.00,
                "涨停价": 1848.00,
                "5日均线": 1670.00,
                "20日均线": 1655.00,
                "前期平台支撑位": 1650.00,
                "成交额": 450000,
                "板块名称": "白酒",
                "最新消息": "无"
            },
            "000858": {
                "股票代码": "000858",
                "股票名称": "五粮液",
                "开盘价": 158.50,
                "实时价": 156.20,
                "最高价": 159.00,
                "涨停价": 174.35,
                "5日均线": 157.50,
                "20日均线": 156.00,
                "前期平台支撑位": 155.80,
                "成交额": 180000,
                "板块名称": "白酒",
                "最新消息": "无"
            },
            # 新能源股
            "300750": {
                "股票代码": "300750",
                "股票名称": "宁德时代",
                "开盘价": 185.20,
                "实时价": 188.50,
                "最高价": 189.00,
                "涨停价": 203.72,
                "5日均线": 186.00,
                "20日均线": 184.50,
                "前期平台支撑位": 184.00,
                "成交额": 520000,
                "板块名称": "新能源",
                "最新消息": "无"
            },
            "002594": {
                "股票代码": "002594",
                "股票名称": "比亚迪",
                "开盘价": 258.00,
                "实时价": 265.50,
                "最高价": 267.00,
                "涨停价": 283.80,
                "5日均线": 260.00,
                "20日均线": 258.00,
                "前期平台支撑位": 257.00,
                "成交额": 680000,
                "板块名称": "新能源",
                "最新消息": "无"
            },
            "601012": {
                "股票代码": "601012",
                "股票名称": "隆基绿能",
                "开盘价": 28.50,
                "实时价": 27.80,
                "最高价": 28.80,
                "涨停价": 31.35,
                "5日均线": 28.20,
                "20日均线": 27.90,
                "前期平台支撑位": 27.70,
                "成交额": 195000,
                "板块名称": "新能源",
                "最新消息": "无"
            },
            # 其他热门股
            "000333": {
                "股票代码": "000333",
                "股票名称": "美的集团",
                "开盘价": 68.50,
                "实时价": 69.20,
                "最高价": 69.80,
                "涨停价": 75.35,
                "5日均线": 68.80,
                "20日均线": 68.20,
                "前期平台支撑位": 68.00,
                "成交额": 145000,
                "板块名称": "家电",
                "最新消息": "无"
            },
            "600276": {
                "股票代码": "600276",
                "股票名称": "恒瑞医药",
                "开盘价": 48.50,
                "实时价": 47.20,
                "最高价": 48.80,
                "涨停价": 53.35,
                "5日均线": 48.00,
                "20日均线": 47.50,
                "前期平台支撑位": 47.30,
                "成交额": 89000,
                "板块名称": "医药",
                "最新消息": "无"
            },
            # 新增股票
            "601869": {
                "股票代码": "601869",
                "股票名称": "长飞光纤",
                "开盘价": 38.50,
                "实时价": 37.20,
                "最高价": 38.80,
                "涨停价": 42.35,
                "5日均线": 38.00,
                "20日均线": 37.50,
                "前期平台支撑位": 37.30,
                "成交额": 68000,
                "板块名称": "通信",
                "最新消息": "无"
            },
            "518880": {
                "股票代码": "518880",
                "股票名称": "中证环保ETF",
                "开盘价": 1.850,
                "实时价": 1.865,
                "最高价": 1.870,
                "涨停价": 2.035,
                "5日均线": 1.855,
                "20日均线": 1.845,
                "前期平台支撑位": 1.840,
                "成交额": 125000,
                "板块名称": "环保",
                "最新消息": "无"
            },
            "603993": {
                "股票代码": "603993",
                "股票名称": "洛阳钼业",
                "开盘价": 8.50,
                "实时价": 8.85,
                "最高价": 8.95,
                "涨停价": 9.35,
                "5日均线": 8.65,
                "20日均线": 8.55,
                "前期平台支撑位": 8.50,
                "成交额": 185000,
                "板块名称": "有色",
                "最新消息": "无"
            },
            "159605": {
                "股票代码": "159605",
                "股票名称": "港股科技50ETF",
                "开盘价": 0.985,
                "实时价": 0.992,
                "最高价": 0.998,
                "涨停价": 1.083,
                "5日均线": 0.988,
                "20日均线": 0.982,
                "前期平台支撑位": 0.980,
                "成交额": 85000,
                "板块名称": "电子",
                "最新消息": "无"
            },
            "159740": {
                "股票代码": "159740",
                "股票名称": "新能源ETF",
                "开盘价": 1.250,
                "实时价": 1.265,
                "最高价": 1.272,
                "涨停价": 1.375,
                "5日均线": 1.258,
                "20日均线": 1.250,
                "前期平台支撑位": 1.248,
                "成交额": 95000,
                "板块名称": "新能源",
                "最新消息": "无"
            },
            "601005": {
                "股票代码": "601005",
                "股票名称": "重庆钢铁",
                "开盘价": 2.15,
                "实时价": 2.12,
                "最高价": 2.18,
                "涨停价": 2.37,
                "5日均线": 2.14,
                "20日均线": 2.11,
                "前期平台支撑位": 2.10,
                "成交额": 78000,
                "板块名称": "钢铁",
                "最新消息": "无"
            },
            "300502": {
                "股票代码": "300502",
                "股票名称": "新易盛",
                "开盘价": 88.50,
                "实时价": 92.30,
                "最高价": 93.50,
                "涨停价": 97.35,
                "5日均线": 90.00,
                "20日均线": 88.50,
                "前期平台支撑位": 88.00,
                "成交额": 225000,
                "板块名称": "通信",
                "最新消息": "无"
            },
            "300308": {
                "股票代码": "300308",
                "股票名称": "中际旭创",
                "开盘价": 125.80,
                "实时价": 130.50,
                "最高价": 132.00,
                "涨停价": 138.38,
                "5日均线": 128.00,
                "20日均线": 126.00,
                "前期平台支撑位": 125.50,
                "成交额": 350000,
                "板块名称": "通信",
                "最新消息": "无"
            },
            "688256": {
                "股票代码": "688256",
                "股票名称": "寒武纪",
                "开盘价": 185.20,
                "实时价": 178.50,
                "最高价": 188.00,
                "涨停价": 203.72,
                "5日均线": 182.00,
                "20日均线": 180.00,
                "前期平台支撑位": 178.00,
                "成交额": 280000,
                "板块名称": "半导体",
                "最新消息": "无"
            },
            "300394": {
                "股票代码": "300394",
                "股票名称": "天孚通信",
                "开盘价": 95.80,
                "实时价": 98.20,
                "最高价": 99.50,
                "涨停价": 105.38,
                "5日均线": 97.00,
                "20日均线": 96.00,
                "前期平台支撑位": 95.50,
                "成交额": 165000,
                "板块名称": "通信",
                "最新消息": "无"
            }
        }

        self.mock_sectors = {
            "银行": {"涨跌幅": -1.2},
            "半导体": {"涨跌幅": 2.5},
            "新能源": {"涨跌幅": -0.8},
            "电子": {"涨跌幅": -0.5},
            "白酒": {"涨跌幅": 0.3},
            "家电": {"涨跌幅": -0.2},
            "医药": {"涨跌幅": 1.5},
            "通信": {"涨跌幅": 0.8},
            "有色": {"涨跌幅": 1.2},
            "钢铁": {"涨跌幅": -0.6},
            "环保": {"涨跌幅": 0.5},
            "化工": {"涨跌幅": -1.0},
            "机械设备": {"涨跌幅": 0.3}
        }

        self.mock_indices = {
            "上证指数": {"涨跌幅": -0.5},
            "深证成指": {"涨跌幅": -0.3},
            "创业板指": {"涨跌幅": 0.2}
        }

    def get_stock_realtime_data(self, stock_code: str) -> Dict[str, Any]:
        """获取模拟股票实时数据"""
        # 如果存在Mock数据，返回Mock数据
        if stock_code in self.mock_stocks:
            return self.mock_stocks[stock_code]

        # 否则返回通用Mock数据（用于测试任何股票代码）
        return {
            "股票代码": stock_code,
            "股票名称": f"股票{stock_code}",
            "开盘价": 10.00,
            "实时价": 9.80,
            "最高价": 10.20,
            "涨停价": 11.00,
            "5日均线": 10.10,
            "20日均线": 9.90,
            "前期平台支撑位": 9.70,
            "成交额": 15000,
            "板块名称": "测试板块",
            "最新消息": "无"
        }

    def get_sector_data(self, sector_name: str) -> Dict[str, Any]:
        """获取模拟板块数据"""
        return self.mock_sectors.get(sector_name, {"涨跌幅": 0})

    def get_market_index_data(self, index_name: str = "上证指数") -> Dict[str, Any]:
        """获取模拟大盘指数数据"""
        return self.mock_indices.get(index_name, {"涨跌幅": 0})


class EastMoneyDataCollector(DataCollector):
    """
    东方财富数据采集器（示例实现）
    实际使用时需要根据东方财富API的具体实现进行调整
    """

    def __init__(self):
        """初始化东方财富数据采集器"""
        self.base_url = "http://push2.eastmoney.com/api/qt"
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

    def get_stock_realtime_data(self, stock_code: str) -> Dict[str, Any]:
        """
        获取股票实时数据

        注意：这是示例代码，实际API调用方式需要根据东方财富的API文档调整
        """
        try:
            # 示例：东方财富API调用（需要根据实际API调整）
            # market_id = "1" if stock_code.startswith("6") else "0"
            # url = f"{self.base_url}/stock/get"
            # params = {"secid": f"{market_id}.{stock_code}"}
            # response = self.session.get(url, params=params)
            # data = response.json()

            # 这里返回示例数据
            return {
                "股票代码": stock_code,
                "股票名称": "示例股票",
                "开盘价": 10.0,
                "实时价": 10.2,
                # ... 其他字段
            }
        except Exception as e:
            print(f"获取股票数据失败: {e}")
            return {}

    def get_sector_data(self, sector_name: str) -> Dict[str, Any]:
        """获取板块数据"""
        # 实际实现需要调用东方财富板块API
        return {"涨跌幅": 0}

    def get_market_index_data(self, index_name: str = "上证指数") -> Dict[str, Any]:
        """获取大盘指数数据"""
        # 实际实现需要调用东方财富指数API
        return {"涨跌幅": 0}


class StockDataAggregator:
    """
    股票数据聚合器
    整合多个数据源的数据，构建完整的市场数据结构
    """

    def __init__(self, data_collector: DataCollector):
        """
        初始化数据聚合器

        Args:
            data_collector: 数据采集器实例
        """
        self.collector = data_collector

    def collect_monitoring_data(
        self,
        stock_code: str,
        chart_type: str,
        trigger_time: str,
        **kwargs
    ) -> Dict[str, Any]:
        """
        采集监控所需的所有数据

        Args:
            stock_code: 股票代码
            chart_type: 图形类型（开盘跳水/破位下跌/冲板回落）
            trigger_time: 触发时间
            **kwargs: 其他特定参数（根据不同图形类型）

        Returns:
            完整的市场数据字典
        """
        # 1. 获取股票基础数据
        stock_data = self.collector.get_stock_realtime_data(stock_code)
        if not stock_data:
            raise ValueError(f"无法获取股票{stock_code}的数据")

        # 2. 获取板块数据
        sector_name = stock_data.get("板块名称", "")
        sector_data = self.collector.get_sector_data(sector_name) if sector_name else {}

        # 3. 获取大盘数据
        market_data = self.collector.get_market_index_data("上证指数")

        # 4. 组装完整数据
        full_data = {
            "股票代码": stock_code,
            "股票名称": stock_data.get("股票名称", ""),
            "触发时间": trigger_time,
            "图形类型": chart_type,

            # 行情数据
            "开盘价": stock_data.get("开盘价") or 0,
            "实时价": stock_data.get("实时价") or 0,
            "最高价": stock_data.get("最高价") or 0,
            "涨停价": stock_data.get("涨停价") or 0,
            "5日均线": stock_data.get("5日均线") or 0,
            "20日均线": stock_data.get("20日均线") or 0,
            "前期平台支撑位": stock_data.get("前期平台支撑位") or 0,

            # 成交量数据
            "触发成交额": stock_data.get("成交额") or 0,
            "成交额放大比例": kwargs.get("成交额放大比例") or 0,
            "当日成交额放大比例": kwargs.get("当日成交额放大比例") or 0,
            "分钟成交额放大比例": kwargs.get("分钟成交额放大比例") or 0,

            # 市场环境
            "板块名称": sector_name or "",
            "板块涨跌幅": sector_data.get("涨跌幅") or 0,
            "大盘名称": "上证指数",
            "大盘涨跌幅": market_data.get("涨跌幅") or 0,

            # 消息面
            "最新消息": stock_data.get("最新消息") or "无",

            # 额外特征
            "额外特征": kwargs.get("额外特征") or ""
        }

        # 添加图形类型特定字段
        if chart_type == "开盘跳水":
            full_data.update({
                "开盘分钟数": kwargs.get("开盘分钟数") or 0,
                "跌幅": kwargs.get("跌幅") or 0.0,
                "均线类型": kwargs.get("均线类型") or 5,
                "均线价格": kwargs.get("均线价格") or 0.0
            })
        elif chart_type == "破位下跌":
            full_data.update({
                "支撑位价格": kwargs.get("支撑位价格") or 0.0,
                "破位后未回弹分钟数": kwargs.get("破位后未回弹分钟数") or 0
            })
        elif chart_type == "冲板回落":
            full_data.update({
                "涨幅": kwargs.get("涨幅") or 0.0,
                "回落幅度": kwargs.get("回落幅度") or 0.0,
                "封板挂单量": kwargs.get("封板挂单量") or 0
            })

        return full_data


# 便捷函数
def create_monitoring_data(
    stock_code: str,
    chart_type: str,
    use_real_data: bool = True,
    **kwargs
) -> Dict[str, Any]:
    """
    创建监控数据（默认使用真实API）

    Args:
        stock_code: 股票代码
        chart_type: 图形类型
        use_real_data: 是否使用真实数据（默认True）
        **kwargs: 其他参数

    Returns:
        完整的监控数据字典

    Example:
        >>> data = create_monitoring_data(
        ...     "600000",
        ...     "开盘跳水",
        ...     trigger_time="09:35",
        ...     开盘分钟数=5,
        ...     跌幅=3.2,
        ...     均线类型=5
        ... )
    """
    # 使用真实数据采集器（优先使用腾讯财经API）
    if use_real_data:
        try:
            from src.monitors.tencent_collector import UnifiedRealDataCollector
            collector = UnifiedRealDataCollector()
        except ImportError:
            print("⚠️  警告: requests包未安装，使用Mock数据")
            print("   安装命令: pip install requests")
            from src.monitors.data_collector import MockDataCollector
            collector = MockDataCollector()
    else:
        from src.monitors.data_collector import MockDataCollector
        collector = MockDataCollector()

    aggregator = StockDataAggregator(collector)

    return aggregator.collect_monitoring_data(
        stock_code=stock_code,
        chart_type=chart_type,
        trigger_time=kwargs.get("trigger_time", "09:35"),
        **kwargs
    )
